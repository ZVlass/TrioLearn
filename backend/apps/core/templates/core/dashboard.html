{% extends 'core/base.html' %}

{% block content %}
  <h2>Welcome, {{ user.get_full_name|default:user.username }}!</h2>

  <!-- Prediction emphasis banner -->
  <div style="padding:.75rem 1rem; margin:.5rem 0 1rem; border:1px solid #ddd; border-radius:.5rem;">
    {% if profile.preferred_format == 'none' or not profile.preferred_format %}
      <strong>Smart pick:</strong>
      We‚Äôll tailor formats automatically. Early signals suggest you might prefer <em>{{ top_format_label }}</em>.
      We‚Äôll adapt as you interact.
    {% else %}
      <strong>Personalisation in action:</strong>
      You selected <em>{{ profile.preferred_format }}</em>{% if preferred_format_label %} ({{ preferred_format_label }}){% endif %};
      based on your activity, we‚Äôre leaning towards <em>{{ top_format_label }}</em>. Tweak anytime in settings.
    {% endif %}
  </div>

  <h3>Your topics</h3>
  {% if topic_display %}
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.25rem 0 1rem;">
      {% for code, label in topic_display %}
        {% if focus_topic == code %}
          <span class="badge" style="background:#007bff;color:#fff;">{{ label }}</span>
        {% else %}
          <a href="?topic={{ code }}" class="badge" style="border:1px solid #007bff;color:#007bff;">
            {{ label }}
          </a>
        {% endif %}
      {% endfor %}
    </div>

    <form method="get" style="margin:.5rem 0 1rem; display:flex; gap:.5rem; align-items:center;">
      <label for="topic">Focus topic:</label>
      <select id="topic" name="topic" onchange="this.form.submit()">
        <option value="" {% if not focus_topic %}selected{% endif %}>All topics</option>
        {% for code, label in topic_display %}
          <option value="{{ code }}" {% if focus_topic == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <noscript><button class="btn" type="submit">Apply</button></noscript>
      {% if focus_topic %}
        <a class="btn btn-secondary" href="{% url 'dashboard' %}" style="margin-left:.5rem;">Clear</a>
      {% endif %}
    </form>
  {% else %}
    <p>No topics selected yet. Update your profile to personalise results.</p>
  {% endif %}

  {% if focus_label %}
    <p class="muted" style="margin:.25rem 0 1rem;">Showing results for: <strong>{{ focus_label }}</strong></p>
  {% endif %}

  {# ================== PRIMARY MODALITY ================== #}
  {% if best_type == 'courses' %}
    <div class="rec-section rec--course primary">
      <h3>Recommended Courses</h3>
      <ul>
        {% for c in top|slice:":2" %}
          <li>
            <a href="{{ c.url|default:'#' }}" class="rec-item" data-item-type="course" data-item-id="{{ c.id }}">
              {{ c.title }}
            </a>
          </li>
        {% empty %}<li>No course suggestions yet.</li>{% endfor %}
      </ul>
    </div>
  {% elif best_type == 'books' %}
    <div class="rec-section rec--book primary">
      <h3>Recommended Books</h3>
      <ul>
        {% for b in top|slice:":2" %}
          <li>
            <a href="{{ b.info_link|default:'#' }}" class="rec-item" data-item-type="book" data-item-id="{{ b.id }}">
              {{ b.title }}
            </a>
          </li>
        {% empty %}<li>No book suggestions yet.</li>{% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="rec-section rec--video primary">
      <h3>Recommended Videos</h3>
      <ul>
        {% for v in top|slice:":2" %}
          <li>
            <a href="{{ v.url|default:'#' }}" class="rec-item" data-item-type="video" data-item-id="{{ v.id }}">
              {{ v.title }}
            </a>
          </li>
        {% empty %}<li>No video suggestions yet.</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {# ================== SUPPORTING MODALITIES ================== #}
  {% if best_type != 'courses' %}
    <div class="rec-section rec--course">
      <h3>Recommended Courses</h3>
      <ul>
        {% for c in supporting.courses|slice:":2" %}
          <li>
            <a href="{{ c.url|default:'#' }}" class="rec-item" data-item-type="course" data-item-id="{{ c.id }}">
              {{ c.title }}
            </a>
          </li>
        {% empty %}<li>No course suggestions yet.</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if best_type != 'books' %}
    <div class="rec-section rec--book">
      <h3>Recommended Books</h3>
      <ul>
        {% for b in supporting.books|slice:":2" %}
          <li>
            <a href="{{ b.info_link|default:'#' }}" class="rec-item" data-item-type="book" data-item-id="{{ b.id }}">
              {{ b.title }}
            </a>
          </li>
        {% empty %}<li>No book suggestions yet.</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if best_type != 'videos' %}
    <div class="rec-section rec--video">
      <h3>Recommended Videos</h3>
      <ul>
        {% for v in supporting.videos|slice:":2" %}
          <li>
            <a href="{{ v.url|default:'#' }}" class="rec-item" data-item-type="video" data-item-id="{{ v.id }}">
              {{ v.title }}
            </a>
          </li>
        {% empty %}<li>No video suggestions yet.</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  {# ================== SURPRISE ================== #}
  {% if surprise %}
    <div class="rec-section rec--surprise">
      <h3>üéÅ Surprise Pick</h3>
      {% if surprise_type == "course" %}
        <a href="{{ surprise.url|default:'#' }}" class="rec-item"
          data-item-type="course" data-item-id="{{ surprise.id }}">
          {{ surprise.title }}
        </a>
      {% elif surprise_type == "book" %}
        <a href="{{ surprise.info_link|default:'#' }}" class="rec-item"
          data-item-type="book" data-item-id="{{ surprise.id }}">
          {{ surprise.title }}
        </a>
      {% elif surprise_type == "video" %}
        <a href="{{ surprise.url|default:'#' }}" class="rec-item"
          data-item-type="video" data-item-id="{{ surprise.id }}">
          {{ surprise.title }}
        </a>
      {% endif %}
    </div>
  {% endif %}


  <h3>Your Learner Profile:</h3>
  <ul>
    <li>Name: {{ user.get_full_name|default:user.username }}</li>
    <li>Gender: {{ gender_label }}</li>
    <li>Region: {{ profile.region }}</li>
    <li>Highest Education: {{ profile.highest_education }}</li>
    <li>Age Band: {{ profile.age_band }}</li>
    <li>Average Session Duration: {{ profile.avg_session_duration_min|floatformat:2 }} minutes</li>
  </ul>

  <script>
  (function(){
    function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
    document.addEventListener('click', function(e){
      const a = e.target.closest('a.rec-item'); if (!a) return;
      fetch("{% url 'track_interaction' %}", {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':getCsrf()},
        body:JSON.stringify({
          item_type:a.dataset.itemType || 'unknown',
          item_id:a.dataset.itemId || '',
          event:'click'
        }),
        keepalive:true
      }).catch(()=>{});
    }, true);
  })();
  </script>
{% endblock %}
